<div class="space-y-3">
  <div class="flex justify-end">
    <div class="bg-ragdoll-green text-white p-3 rounded-2xl rounded-br-none max-w-xs shadow-md">
      <p class="text-sm font-semibold">You</p>
      <p class="text-sm break-words">{{ question }}</p>
    </div>
  </div>
  <div class="flex justify-start">
    <div class="bg-gray-100 text-gray-800 p-3 rounded-2xl rounded-tl-none max-w-lg shadow-md border border-gray-200">
      <p class="text-sm font-semibold text-gray-800 mb-1">RAG Engine</p>
      <p class="text-sm break-words whitespace-pre-wrap">{{ answer }}</p>
      <p class="text-[11px] text-gray-500 mt-2">
        Sources: {{ (sources_used or []) | join(", ") or "none" }} ·
        Response time: {{ response_time or 0 }}s · LLM: {{ "yes" if used_llm else "no" }}
      </p>
    </div>
  </div>
  {% set vector_hits = vector_hits_raw or vector_docs %}
  {% set graph_hits = graph_hits_raw or graph_docs %}
  <details class="bg-white border border-gray-200 rounded-2xl p-3 text-xs text-gray-600" {% if vector_hits or graph_hits %}open{% endif %}>
    <summary class="cursor-pointer font-semibold text-gray-800">
      Show Retrieval Trace (Context Used)
    </summary>
    <div class="mt-2 space-y-2">
      {% if vector_hits %}
      <div>
        <p class="font-semibold text-gray-700">Vector hits</p>
        <ul class="list-disc pl-4 space-y-1">
          {% for doc in vector_hits %}
          <li>
            {{ (doc.content or "")[:220] }}
            {% if doc.metadata %}
            <span class="text-[10px] text-gray-400">(source: {{ doc.metadata.get("source") or "unknown" }})</span>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      {% if graph_hits %}
      <div>
        <p class="font-semibold text-gray-700">Graph hits</p>
        <ul class="list-disc pl-4 space-y-1">
          {% for doc in graph_hits %}
          <li>
            {{ (doc.content or "")[:220] }}
            {% if doc.metadata %}
            <span class="text-[10px] text-gray-400">
              (type: {{ doc.metadata.get("node_type") or "node" }}, id: {{ doc.metadata.get("node_id") or "n/a" }}
              {% if doc.metadata.get("connected_to") %} | neighbors: {{ doc.metadata.get("connected_to") | join(", ") }}{% endif %})
            </span>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      {% if not vector_hits and not graph_hits %}
      <p class="text-gray-400">No retrieval context available. Run ingestion first.</p>
      {% endif %}
    </div>
  </details>
</div>
