<div class="space-y-3">
  <div class="flex justify-end">
    <div class="bg-ragdoll-green text-white p-3 rounded-2xl rounded-br-none max-w-xs shadow-md">
      <p class="text-sm font-semibold">You</p>
      <p class="text-sm break-words">{{ question }}</p>
    </div>
  </div>
  <div class="flex justify-start">
    <div class="bg-gray-100 text-gray-800 p-3 rounded-2xl rounded-tl-none max-w-lg shadow-md border border-gray-200">
      <p class="text-sm font-semibold text-gray-800 mb-1">RAG Engine</p>
      <p class="text-sm break-words whitespace-pre-wrap">{{ answer }}</p>
      <p class="text-[11px] text-gray-500 mt-2">
        Retriever: {{ retriever_used or "vector" }} 路
        Documents: {{ num_documents or 0 }} 路
        Sources: {{ (sources_used or []) | join(", ") or "none" }} 路
        Response time: {{ response_time or 0 }}s 路 LLM: {{ "yes" if used_llm else "no" }}
      </p>
    </div>
  </div>
  <details class="bg-white border border-gray-200 rounded-2xl p-3 text-xs text-gray-600" {% if documents %}open{% endif
    %}>
    <summary class="cursor-pointer font-semibold text-gray-800">
      Show Retrieved Documents ({{ num_documents or 0 }} total)
    </summary>
    <div class="mt-2 space-y-2">
      {% if documents %}
      <div>
        <p class="font-semibold text-gray-700">Retrieved from: {{ retriever_used or "vector" }} retriever</p>
        <ul class="list-disc pl-4 space-y-1">
          {% for doc in documents %}
          <li>
            <span class="break-words">{{ (doc.page_content or "")[:300] }}{% if (doc.page_content or "")|length > 300
              %}...{% endif %}</span>
            {% if doc.metadata %}
            <div class="text-[10px] text-gray-400 mt-1">
              Source: {{ doc.metadata.get("source") or "unknown" }}
              {% if doc.metadata.get("page") %} | Page: {{ doc.metadata.get("page") }}{% endif %}
              {% if doc.metadata.get("hop_distance") is not none %} | Hops: {{ doc.metadata.get("hop_distance") }}{%
              endif %}
              {% if doc.metadata.get("node_id") %} | Node: {{ doc.metadata.get("node_id") }}{% endif %}
            </div>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
      </div>
      {% else %}
      <p class="text-gray-400">No retrieval context available. Run ingestion first or check if documents were indexed.
      </p>
      {% endif %}
    </div>
  </details>
</div>